<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dynamic models and simulations • simlandr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Dynamic models and simulations">
<meta property="og:description" content="simlandr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">simlandr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9002</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/simulation.html">Dynamic models and simulations</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/Sciurus365/simlandr/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="simulation_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Dynamic models and simulations</h1>
                        <h4 class="author">Jingmeng Cui</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/Sciurus365/simlandr/blob/master/vignettes/simulation.Rmd"><code>vignettes/simulation.Rmd</code></a></small>
      <div class="hidden name"><code>simulation.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Sciurus365/simlandr">simlandr</a></span><span class="op">)</span></code></pre></div>
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>The whole story starts with a dynamic model.</p>
<p>Formally speaking, a <strong>dynamic model</strong> is a set of equations that specify how all the variables of a system changes over time. It usually takes the form of (stochastic) differential/difference equations.</p>
<p>These dynamic models is rather abstract, so they can only be used for computation when they are implemented in a simulation function. A <strong>simulation function</strong> is a function that simulate how the model variables change over time. It takes some parameters as input, and returns a recording of the simulation process.</p>
<p>Currently, the whole package can only support the simulation function with certain format. It should takes (besides from other parameters) lists of model parameters as input, and give a matrix as the output. If your original simulation function is in another format, maybe some modification is needed.</p>
<p><code>simlandr</code> package provides a simulation function for a simple toy model, which is called <code><a href="../reference/sim_fun_test.html">sim_fun_test()</a></code>. You can use this as an example of the correct function format. I will also use this function as an example through out this vignette. It takes <code>par1</code> and <code>par2</code> as parameters: <code>par1</code> should be a list containing <code>var1</code> and <code>var2</code>, and <code>par2</code> should be a list containing <code>var3</code>. It takes this nested structure because real-life functions often have a bunch of parameters in different categories (e.g., starting values, model parameters, parameters that control the behavior of the simulation function, etc.) To avoid confusions in terms, the package refers to these first-layer parameters as <em>par</em>s, and second-layer parameters as <em>var</em>s.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sim_fun_test</span>
<span class="co">#&gt; function (par1, par2, length = 1000) </span>
<span class="co">#&gt; {</span>
<span class="co">#&gt;     output &lt;- matrix(nrow = length, ncol = 3)</span>
<span class="co">#&gt;     colnames(output) &lt;- c("out1", "out2", "out3")</span>
<span class="co">#&gt;     output[1, ] &lt;- c(par1$var1, par2$var2, rnorm(1, sd = 0.01))</span>
<span class="co">#&gt;     for (i in 2:length) {</span>
<span class="co">#&gt;         output[i, 1] &lt;- 0.5 * output[i - 1, 1] + output[i - 1, </span>
<span class="co">#&gt;             2] + par2$var3 + par1$var1 * par2$var2</span>
<span class="co">#&gt;         output[i, 2] &lt;- -0.5 * output[i - 1, 1] + output[i - </span>
<span class="co">#&gt;             1, 2] + par2$var3</span>
<span class="co">#&gt;         output[i, 3] &lt;- output[i - 1, 3] + rnorm(1, sd = 0.01)</span>
<span class="co">#&gt;     }</span>
<span class="co">#&gt;     return(output)</span>
<span class="co">#&gt; }</span>
<span class="co">#&gt; &lt;bytecode: 0x7f99a8765230&gt;</span>
<span class="co">#&gt; &lt;environment: namespace:simlandr&gt;</span></code></pre></div>
</div>
<div id="single-simulation" class="section level1">
<h1 class="hasAnchor">
<a href="#single-simulation" class="anchor"></a>Single simulation</h1>
<p>For the author of a simulation function, running a single simulation is easy. You can just run the function normally, and assign the output to a variable. (If you are using others’ simulation function, please read its documentation or ask the author about how to run it correctly.)</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">single_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_fun_test.html">sim_fun_test</a></span><span class="op">(</span>
  par1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>var1 <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,
  par2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>var2 <span class="op">=</span> <span class="fl">1</span>, var3 <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">single_test</span><span class="op">)</span>
<span class="co">#&gt;          out1     out2         out3</span>
<span class="co">#&gt; [1,]  1.00000  1.00000 -0.008033143</span>
<span class="co">#&gt; [2,]  2.50000  0.50000 -0.014677886</span>
<span class="co">#&gt; [3,]  2.75000 -0.75000 -0.017070636</span>
<span class="co">#&gt; [4,]  1.62500 -2.12500 -0.020056053</span>
<span class="co">#&gt; [5,] -0.31250 -2.93750 -0.027710614</span>
<span class="co">#&gt; [6,] -2.09375 -2.78125  0.003235618</span></code></pre></div>
</div>
<div id="out-of-memory-storage-of-the-simulation-output" class="section level1">
<h1 class="hasAnchor">
<a href="#out-of-memory-storage-of-the-simulation-output" class="anchor"></a>Out-of-memory storage of the simulation output</h1>
<p>Sometimes the output of the simulation is so large that it cannot be handled properly in the following computation. (Rule of thumb: retain matrices of &gt; 1 GB in memory is likely to produce future problems in a computer with 8 GB memory.) In this case, you can use the <code>bigmemory</code> package to put it into your hard drive. <code>bigmemory</code> only preserves a pointer in the memory, so it can save the memory space significantly. In most cases, you can treat it as a normal matrix. As far as I have tested, <code>simlandr</code> is fully compatible with <code>bigmemory</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># NOT RUN</span>
<span class="va">single_test</span> <span class="op">&lt;-</span> <span class="fu">bigmemory</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bigmemory/man/big.matrix.html">as.big.matrix</a></span><span class="op">(</span><span class="va">single_test</span>, backingfile <span class="op">=</span> <span class="st">"single_test.bin"</span>, descriptorfile <span class="op">=</span> <span class="st">"single_test.desc"</span><span class="op">)</span></code></pre></div>
<p>The pointer only exists in a single session. In other words, if you close the session and reload the workspace image, the pointers will become <code>NULL</code>, and <code>bigmemory</code> attachment does not restore by itself. In order to use it again, use the following command to attach the file.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># NOT RUN</span>
<span class="va">single_test</span> <span class="op">&lt;-</span> <span class="fu">bigmemory</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bigmemory/man/attach.big.matrix.html">attach.big.matrix</a></span><span class="op">(</span><span class="st">"single_test"</span><span class="op">)</span></code></pre></div>
<hr>
<p><strong>⚠ WARNING</strong></p>
<p>Due to a bug of RStudio (<a href="https://github.com/rstudio/rstudio/issues/8923" class="uri">https://github.com/rstudio/rstudio/issues/8923</a>), its variable inspector cannot handle objects with null external pointers. Sometimes it results in a fatal error when loading workspace image with previous <code>bigmemory</code>-related objects.</p>
<p>Current work-around before the bug is fixed:</p>
<ol style="list-style-type: decimal">
<li>Turn off “Restore .RData into workspace at startup” at Tools -&gt; Project Options -&gt; General</li>
<li>Switch the variable inspector to “Manual Refresh Only”</li>
<li>Load the image attach all <code>bigmemory</code>-related objects.</li>
</ol>
<p>After that, you can safely use/refresh the variable inspector.</p>
<hr>
<p>To reuse these images on a hard drive, <code>big.matrix</code> class in <code>bigmemory</code> requires an explicit file name for each matrix. This can be cumbersome if you need to handle a lot of matrices. (And this is even a bigger problem for batch simulation; see next section.) Therefore, <code>simlandr</code> provides a <code>hash-big.matrix</code> class to solve this problem. The <code>hash-big.matrix</code> class is a modification of <code>big.matrix</code> class in <code>big.memory</code> package, but it automatically generates the file names using the md5 values of the matrices. (For those who are not familiar with md5: it is a hash algorithm that can guarantee to give different names to different matrices in a reasonable simulation context.) The md5 value is also stored in the <code>md5</code> slot of <code>hash-big.matrix</code> objects. Therefore, the file link can also be restored automatically without having to specify a file name. By default, all the backing files of <code>hash-big.matrix</code> objects are in <code>\bp</code> directory.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># NOT RUN</span>
<span class="va">single_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hash_big.matrix-class.html">as.hash_big.matrix</a></span><span class="op">(</span><span class="va">single_test</span><span class="op">)</span>
<span class="va">single_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hash_big.matrix-class.html">attach.hash_big.matrix</a></span><span class="op">(</span><span class="va">single_test</span><span class="op">)</span></code></pre></div>
</div>
<div id="batch-simulation" class="section level1">
<h1 class="hasAnchor">
<a href="#batch-simulation" class="anchor"></a>Batch simulation</h1>
<p>Sometimes you need to simulate a set of models with different parameter values. <code>simlandr</code> provides several tools to do this easily.</p>
<p>First, you need to make a <code>var_grid</code> to specify the conditions of these simulations in terms of <code>var</code> values. The following is an example.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Step 1: create a variable set</span>
<span class="va">batch_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_var_set.html">new_var_set</a></span><span class="op">(</span><span class="op">)</span>

<span class="co">## Step 2: add variable and its starting, end, and increment values of the sequence (passed to `seq()`) to the set.</span>
<span class="va">batch_test</span> <span class="op">&lt;-</span> <span class="va">batch_test</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/new_var_set.html">add_var</a></span><span class="op">(</span><span class="st">"par2"</span>, <span class="st">"var3"</span>, <span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">0.1</span><span class="op">)</span>

<span class="co">## Step 3: make variable grids</span>
<span class="va">batch_test_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_var_grid.html">make_var_grid</a></span><span class="op">(</span><span class="va">batch_test</span><span class="op">)</span></code></pre></div>
<p>Then you can run the batch simulation.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co">## Step 4: run the batch simulation</span>
<span class="va">batch_test_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/modified_simulation.html">batch_simulation</a></span><span class="op">(</span><span class="va">batch_test_grid</span>, <span class="va">sim_fun_test</span>,
  default_list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    par1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>var1 <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,
    par2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>var2 <span class="op">=</span> <span class="fl">0</span>, var3 <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span>
<span class="va">batch_test_result</span>
<span class="co">#&gt; Output(s) from 6 simulations.</span>
<span class="va">batch_test_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/attach_all_matrices.html">attach_all_matrices</a></span><span class="op">(</span><span class="va">batch_test_result</span><span class="op">)</span>

<span class="co"># WARNING if you are using bigmemory: Due to a bug of RStudio (https://github.com/rstudio/rstudio/issues/8923), its variable inspector cannot handle objects with null external pointers. Work around: Turn off "automatically load workspace image"; change the variable inspector to "Manual refresh only", and then load the image and use attach_all_matrices for all batch simulations. After that, you can safely use the variable inspector. #</span>

<span class="co"># Batch simulation with two parameters</span>

<span class="va">batch_test2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_var_set.html">new_var_set</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">batch_test2</span> <span class="op">&lt;-</span> <span class="va">batch_test2</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/new_var_set.html">add_var</a></span><span class="op">(</span><span class="st">"par1"</span>, <span class="st">"var1"</span>, <span class="op">-</span><span class="fl">0.2</span>, <span class="fl">0.2</span>, <span class="fl">0.2</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/new_var_set.html">add_var</a></span><span class="op">(</span><span class="st">"par2"</span>, <span class="st">"var2"</span>, <span class="op">-</span><span class="fl">0.2</span>, <span class="fl">0.2</span>, <span class="fl">0.2</span><span class="op">)</span>
<span class="va">batch_test_grid2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_var_grid.html">make_var_grid</a></span><span class="op">(</span><span class="va">batch_test2</span><span class="op">)</span>

<span class="va">batch_test_result2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/modified_simulation.html">batch_simulation</a></span><span class="op">(</span><span class="va">batch_test_grid2</span>, <span class="va">sim_fun_test</span>,
  bigmemory <span class="op">=</span> <span class="cn">FALSE</span>,
  default_list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    par1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>var1 <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,
    par2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>var2 <span class="op">=</span> <span class="fl">0</span>, var3 <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span>
<span class="va">batch_test_result2</span>
<span class="co">#&gt; Output(s) from 9 simulations.</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jingmeng Cui.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
